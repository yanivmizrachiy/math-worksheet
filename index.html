<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>math worksheet</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<!-- PDF LIBRARIES -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root{
    --ink:#000;
    --bg:#fff;
    --grid:#cccccc;
    --tab:#f3f3f3;
    --tabActive:#000;
    --tabActiveText:#fff;
    --radius:12px;
  }
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background: var(--bg);
    color: var(--ink);
    line-height: 1.6;
  }
  h1, h2 { text-align: center; color: var(--ink); }

  /* Tabs */
  .tabs-wrap{
    max-width: 1100px;
    margin: 0 auto 16px auto;
  }
  .tabs{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:center;
    align-items:center;
    margin-bottom: 14px;
  }
  .tab{
    appearance:none;
    border:1px solid var(--ink);
    background: var(--tab);
    color: var(--ink);
    padding: 10px 14px;
    border-radius: 999px;
    cursor:pointer;
    font-size: 14px;
    line-height: 1;
    user-select:none;
  }
  .tab[aria-selected="true"]{
    background: var(--tabActive);
    color: var(--tabActiveText);
  }

  /* Action bar */
  .actionbar{
    display:flex;
    gap:10px;
    justify-content:center;
    flex-wrap:wrap;
    margin: 8px 0 18px 0;
  }
  #pdfButton {
    padding: 12px 20px;
    background: #000000;
    color: #ffffff;
    font-size: 16px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
  }
  #pdfScope{
    border:1px solid var(--ink);
    border-radius: 10px;
    padding: 10px 12px;
    background:#fff;
    font-size: 14px;
  }

  /* Content sections */
  .subject{
    display:none;
    max-width: 1100px;
    margin: 0 auto;
  }
  .subject.active{
    display:block;
  }

  .section {
    background: #ffffff;
    padding: 20px;
    margin: 24px 0;
    border-radius: var(--radius);
    border: 1px solid var(--ink);
    box-shadow: none;
  }

  .question {
    background: #ffffff;
    padding: 14px;
    border-radius: 10px;
    margin-bottom: 18px;
    border-right: 5px solid var(--ink);
  }

  .coordinates { font-weight: 700; display: block; margin-bottom: 8px; color: var(--ink); }
  .sub-question { margin-top: 8px; color: var(--ink); }

  canvas {
    display: block;
    margin: 12px auto;
    width: 560px;
    height: 420px;
    background: #ffffff;
    border: 1px solid var(--ink);
    border-radius: 10px;
  }

  @media (max-width: 640px){
    canvas { width: 320px; height: 240px; }
  }
</style>
</head>

<body>

<div class="tabs-wrap">
  <h1>驻 注 转拽</h1>

  <div class="tabs" role="tablist" aria-label="砖 转拽">
    <button class="tab" role="tab" id="tab-par" aria-controls="panel-par" aria-selected="true"  data-target="par">拽转</button>
    <button class="tab" role="tab" id="tab-tri" aria-controls="panel-tri" aria-selected="false" data-target="tri">砖砖</button>
    <button class="tab" role="tab" id="tab-fun" aria-controls="panel-fun" aria-selected="false" data-target="fun">驻拽爪转</button>
    <button class="tab" role="tab" id="tab-lin" aria-controls="panel-lin" aria-selected="false" data-target="lin">砖专 砖专</button>
    <button class="tab" role="tab" id="tab-prob" aria-controls="panel-prob" aria-selected="false" data-target="prob">住转专转</button>
  </div>

  <div class="actionbar">
    <button id="pdfButton" onclick="downloadPDF()"> 专 -PDF</button>

    <label id="pdfScope" for="pdfScopeSelect">
      爪 PDF:
      <select id="pdfScopeSelect">
        <option value="current" selected>砖 </option>
        <option value="all"> 砖</option>
      </select>
    </label>
  </div>
</div>

<!--  注 转 砖 -->
<div id="contentRoot"></div>

<!-- ===================== SUBJECT FILES MANIFEST ===================== -->
<script>
  // 转 住祝  拽爪 住驻 砖  注转 -PDF/注爪
  const SUBJECTS = {
    par: { file: "subjects/parallelograms.html", init: "initParallelograms" },
    tri: { file: "subjects/triangles.html",      init: null },
    fun: { file: "subjects/functions.html",      init: null },
    lin: { file: "subjects/lines.html",          init: null },
    prob:{ file: "subjects/probability.html",    init: null }
  };
</script>

<!-- ===================== TABS LOGIC (WITH DYNAMIC LOADING) ===================== -->
<script>
(function(){
  const tabs = Array.from(document.querySelectorAll(".tab"));
  const root = document.getElementById("contentRoot");
  let activeKey = "par";

  function setTabUI(subjectKey){
    tabs.forEach(t=>{
      const on = t.dataset.target === subjectKey;
      t.setAttribute("aria-selected", on ? "true" : "false");
    });
    activeKey = subjectKey;
  }

  async function loadSubject(subjectKey){
    setTabUI(subjectKey);

    const meta = SUBJECTS[subjectKey];
    if(!meta){
      root.innerHTML = "";
      return;
    }

    //   拽抓 驻注, 爪 注 拽爪专
    let html = "";
    try{
      const res = await fetch(meta.file, { cache: "no-store" });
      if(!res.ok) throw new Error("fetch failed");
      html = await res.text();
    }catch{
      html = `
        <section class="subject active" data-subject="${subjectKey}">
          <h1>祝 注</h1>
          <div class="section">
            <h2>拽抓 注  拽 转: ${meta.file}</h2>
          </div>
        </section>
      `;
    }

    root.innerHTML = html;

    // MathJax 专 注
    if (window.MathJax && window.MathJax.typesetPromise) {
      try { await window.MathJax.typesetPromise(); } catch {}
    }

    // 爪专 ( 专 init)
    if(meta.init && typeof window[meta.init] === "function"){
      try{ window[meta.init](); }catch{}
    }
  }

  tabs.forEach(t=>{
    t.addEventListener("click", ()=> loadSubject(t.dataset.target));
    t.addEventListener("keydown", (e)=>{
      if(e.key !== "ArrowLeft" && e.key !== "ArrowRight") return;
      e.preventDefault();
      const i = tabs.indexOf(t);
      const next = e.key === "ArrowLeft" ? (i+1) % tabs.length : (i-1+tabs.length) % tabs.length;
      tabs[next].focus();
      loadSubject(tabs[next].dataset.target);
    });
  });

  // 注转 专专转 : 拽转
  window.addEventListener("load", ()=> loadSubject("par"));
})();
</script>

<!-- ===================== PDF EXPORTER (CURRENT OR ALL) ===================== -->
<script>
async function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const scope = document.getElementById("pdfScopeSelect").value;

  let subjectsHTML = [];

  if(scope === "current"){
    // 砖转砖  砖专 注 住
    const currentSubject = document.querySelector("#contentRoot .subject");
    if(currentSubject){
      subjectsHTML = [currentSubject.outerHTML];
    }
  } else {
    // 注 转  拽爪 砖 ( 砖专 " 砖" 注  注 专转)
    const keys = Object.keys(SUBJECTS);
    for(const k of keys){
      const meta = SUBJECTS[k];
      if(!meta || !meta.file) continue;
      try{
        const res = await fetch(meta.file, { cache: "no-store" });
        if(res.ok){
          const html = await res.text();
          subjectsHTML.push(html);
        }
      }catch{}
    }
  }

  if(subjectsHTML.length === 0){
    alert(" 砖转 爪 -PDF  砖专.");
    return;
  }

  //  DOM   砖 砖专, 拽 砖转  拽 砖
  const staging = document.createElement("div");
  staging.style.position = "fixed";
  staging.style.left = "-2000px";
  staging.style.top = "0";
  staging.style.width = "1200px";
  staging.style.direction = "rtl";
  document.body.appendChild(staging);

  staging.innerHTML = subjectsHTML.join("\n");

  const subjectsToExport = Array.from(staging.querySelectorAll(".subject"));
  const questions = subjectsToExport.flatMap(s => Array.from(s.querySelectorAll(".question")));

  if(questions.length === 0){
    document.body.removeChild(staging);
    alert(" 砖转 爪 -PDF  砖专.");
    return;
  }

  // 拽爪转 砖 2 砖转 注 (拽  爪)
  const groups = [];
  for (let i=0; i < questions.length; i += 2) {
    const pair = [questions[i]];
    if (questions[i+1]) pair.push(questions[i+1]);
    groups.push(pair);
  }

  const pdf = new jsPDF("p", "mm", "a4");
  const pdfW = 210;
  const pdfH = 297;

  //  砖爪专 (canvas) 住 -PDF,  砖转砖 拽住 转 住
  // 专拽 砖  砖 拽住 爪专 专注 转;  " 砖" 爪 PDF 注 转,
  //  拽住 砖 砖 砖 注/爪专 驻注  专拽 注 砖转住祝  init  拽转.
  // ( 转 注拽专 砖  拽, 专拽 注砖  专.)
  const liveCanvases = new Map();
  document.querySelectorAll("#contentRoot canvas[id]").forEach(c => liveCanvases.set(c.id, c));

  for (let g = 0; g < groups.length; g++) {
    const temp = document.createElement("div");
    temp.style.direction = "rtl";
    temp.style.width = "900px";
    temp.style.padding = "40px";
    temp.style.background = "#ffffff";
    temp.style.boxSizing = "border-box";
    temp.style.position = "fixed";
    temp.style.left = "-2000px";
    temp.style.top = "0";
    document.body.appendChild(temp);

    for (const el of groups[g]) {
      const clone = el.cloneNode(true);

      // Replace canvas with img snapshot (so it prints)
      const c = clone.querySelector("canvas");
      if (c && c.id && liveCanvases.has(c.id)) {
        const origCanvas = liveCanvases.get(c.id);
        try {
          const imgURL = origCanvas.toDataURL("image/png");
          const img = document.createElement("img");
          img.src = imgURL;
          img.style.width = "560px";
          img.style.height = "420px";
          c.replaceWith(img);
        } catch {}
      }

      clone.style.marginBottom = "40px";
      temp.appendChild(clone);
    }

    // Ensure MathJax rendered inside temp before snapshot
    if (window.MathJax && window.MathJax.typesetPromise) {
      try { await window.MathJax.typesetPromise([temp]); } catch {}
    }

    const canvas = await html2canvas(temp, {
      scale: 2,
      useCORS: true,
      backgroundColor: "#ffffff"
    });

    document.body.removeChild(temp);

    const imgW = pdfW;
    const imgH = (canvas.height * pdfW) / canvas.width;

    let finalW = imgW;
    let finalH = imgH;

    if (finalH > pdfH - 10) {
      const scale = (pdfH - 10) / finalH;
      finalW *= scale;
      finalH *= scale;
    }

    if (g > 0) pdf.addPage();

    const yOffset = (pdfH - finalH) / 2;
    pdf.addImage(canvas.toDataURL("image/png"), "PNG", 0, yOffset, finalW, finalH);
  }

  document.body.removeChild(staging);
  pdf.save("worksheet.pdf");
}
</script>

<!-- ===================== DRAWING CODE (UNCHANGED VALUES) ===================== -->
<script>
function lineBounds(points){const xs=points.map(p=>p[0]),ys=points.map(p=>p[1]);return{minX:Math.min(...xs)-2,maxX:Math.max(...xs)+2,minY:Math.min(...ys)-2,maxY:Math.max(...ys)+2};}
function labelPlugin(labels){return{id:'pointLabels',afterDraw(chart){const ctx=chart.ctx;ctx.save();ctx.font='bold 12px Arial';ctx.fillStyle='#000';labels.forEach(pt=>{const xp=chart.scales.x.getPixelForValue(pt.x),yp=chart.scales.y.getPixelForValue(pt.y);const off=8*(pt.side==='rtl'?-1:1);ctx.fillText(pt.label,xp+off,yp-8);});ctx.restore();}};}

function drawPlane(canvasId, vertices, extraLines=[]) {
  const coords = vertices.map(v => [v.x, v.y]);
  const b = lineBounds(coords);
  const xmin = b.minX, xmax = b.maxX, ymin = b.minY, ymax = b.maxY;
  const axisX = [{x:xmin,y:0},{x:xmax,y:0}];
  const axisY = [{x:0,y:ymin},{x:0,y:ymax}];
  const closed = coords.concat([coords[0]]);
  const el = document.getElementById(canvasId);
  if(!el) return;
  const ctx = el.getContext('2d');
  if(ctx.chartInstance) ctx.chartInstance.destroy();
  const labels = vertices.map(v => ({x:v.x, y:v.y, label:v.label, side:v.side||'ltr'}));

  const datasets = [
    {data: axisX, showLine: true, borderColor:'#000', pointRadius:0, borderWidth:1},
    {data: axisY, showLine: true, borderColor:'#000', pointRadius:0, borderWidth:1},
    {data: closed.map(p => ({x:p[0], y:p[1]})), showLine:true, fill:true, borderColor:'#000', backgroundColor:'rgba(0,0,0,0.1)', pointRadius:4, borderWidth:2},
    {data: coords.map(p => ({x:p[0], y:p[1]})), showLine:false, pointRadius:5, backgroundColor:'#000'}
  ];

  extraLines.forEach(line => {
    datasets.push({data: line.points, showLine:true, borderColor:'#000', pointRadius:0, borderWidth:1, borderDash: line.dashed ? [5,5] : []});
  });

  const chart = new Chart(ctx,{
    type:'scatter',
    data: {datasets: datasets},
    options: {
      responsive: false,
      maintainAspectRatio: false,
      scales: {
        x: {min:xmin,max:xmax,grid:{color:'#cccccc'}},
        y: {min:ymin,max:ymax,grid:{color:'#cccccc'}}
      },
      plugins: {legend:{display:false}}
    },
    plugins: [labelPlugin(labels)]
  });

  ctx.chartInstance = chart;
}

/* INIT FOR PARALLELOGRAMS (VALUES UNCHANGED) */
function initParallelograms(){
  const Q1_A={x:-5,y:2,label:'A'},Q1_B={x:-3,y:6,label:'B'},Q1_D={x:1,y:2,label:'D'};
  const Q1_C={x:Q1_B.x+(Q1_D.x-Q1_A.x),y:Q1_B.y+(Q1_D.y-Q1_A.y),label:'C'};

  const Q2_A={x:1,y:3,label:'A'},Q2_B={x:-6,y:3,label:'B'},Q2_C={x:-2,y:0,label:'C'};
  const Q2_D={x:Q2_C.x+(Q2_A.x-Q2_B.x),y:Q2_C.y+(Q2_A.y-Q2_B.y),label:'D'};

  // Calculate foot H from A to CD
  const slopeCD = (Q2_D.y - Q2_C.y)/(Q2_D.x - Q2_C.x);
  const slopePerp = -1/slopeCD;
  const interceptA = Q2_A.y - slopePerp*Q2_A.x;
  const interceptCD = Q2_C.y - slopeCD*Q2_C.x;
  const H_x = (interceptCD - interceptA)/(slopePerp - slopeCD);
  const H_y = slopePerp*H_x + interceptA;
  const H = {x:H_x, y:H_y};

  const Q3_A={x:0,y:0,label:'A'},Q3_B={x:4,y:0,label:'B'},Q3_D={x:3,y:3,label:'D'},Q3_C={x:7,y:3,label:'C'};
  const Q4_A={x:-2,y:3,label:'A'},Q4_B={x:-2,y:7,label:'B'},Q4_C={x:0,y:5,label:'C'},Q4_D={x:0,y:1,label:'D'};
  const Q5_A={x:-3,y:-5,label:'A'},Q5_B={x:-1,y:1,label:'B'},Q5_C={x:3,y:5,label:'C'},Q5_D={x:1,y:-1,label:'D'};

  // Q6 adjusted to match uploaded image
  const Q6_A={x:0,y:4,label:'A'}, Q6_B={x:1,y:10,label:'B'}, Q6_C={x:5,y:10,label:'C'}, Q6_D={x:4,y:4,label:'D'};

  Q1_A.side='rtl';Q1_B.side='rtl';Q1_C.side='ltr';Q1_D.side='ltr';
  Q2_A.side='rtl';Q2_B.side='rtl';Q2_C.side='ltr';Q2_D.side='ltr';
  Q3_A.side='rtl';Q3_B.side='rtl';Q3_C.side='ltr';Q3_D.side='ltr';
  Q4_A.side='rtl';Q4_B.side='rtl';Q4_C.side='ltr';Q4_D.side='ltr';
  Q5_A.side='rtl';Q5_B.side='rtl';Q5_C.side='ltr';Q5_D.side='ltr';
  Q6_A.side='rtl';Q6_B.side='rtl';Q6_C.side='ltr';Q6_D.side='ltr';

  drawPlane('chart1',[Q1_A,Q1_B,Q1_C,Q1_D], [
    {points:[{x:Q1_A.x,y:Q1_A.y},{x:Q1_C.x,y:Q1_C.y}]},
    {points:[{x:Q1_B.x,y:Q1_B.y},{x:Q1_D.x,y:Q1_D.y}]}
  ]);

  drawPlane('chart2',[Q2_A,Q2_B,Q2_C,Q2_D], [
    {points:[{x:Q2_A.x,y:Q2_A.y},{x:H.x,y:H.y}], dashed:true}
  ]);

  drawPlane('chart3',[Q3_A,Q3_B,Q3_C,Q3_D]);
  drawPlane('chart4',[Q4_A,Q4_B,Q4_C,Q4_D]);
  drawPlane('chart5',[Q5_A,Q5_B,Q5_C,Q5_D]);
  drawPlane('chart6',[Q6_A,Q6_B,Q6_C,Q6_D]);
}
</script>

</body>
</html>
